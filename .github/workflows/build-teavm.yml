name: Build TeaVM Java Apps
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-teavm:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build with Maven
      run: |
        echo "üìÅ Current directory structure:"
        ls -la
        
        if [ ! -d "JavaDocs" ]; then
          echo "üìã Creating JavaDocs structure..."
          mkdir -p JavaDocs/src
        fi
        
        echo "üìÅ JavaDocs structure:"
        find JavaDocs -type f -name "*.java" 2>/dev/null | head -10 || echo "No Java files found - will create default"
        
        # Create files if they don't exist
        if [ ! -f "JavaDocs/pom.xml" ]; then
          echo "üìÑ Creating pom.xml..."
          cat > JavaDocs/pom.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <groupId>com.cslibre</groupId>
    <artifactId>text-demo</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>
    
    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <teavm.version>0.8.0</teavm.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>
    
    <dependencies>
        <dependency>
            <groupId>org.teavm</groupId>
            <artifactId>teavm-classlib</artifactId>
            <version>${teavm.version}</version>
        </dependency>
        <dependency>
            <groupId>org.teavm</groupId>
            <artifactId>teavm-jso-apis</artifactId>
            <version>${teavm.version}</version>
        </dependency>
        <dependency>
            <groupId>org.teavm</groupId>
            <artifactId>teavm-platform</artifactId>
            <version>${teavm.version}</version>
        </dependency>
    </dependencies>
    
    <build>
        <sourceDirectory>src</sourceDirectory>
        <plugins>
            <plugin>
                <groupId>org.teavm</groupId>
                <artifactId>teavm-maven-plugin</artifactId>
                <version>${teavm.version}</version>
                <executions>
                    <execution>
                        <id>web-client</id>
                        <phase>compile</phase>
                        <goals>
                            <goal>compile</goal>
                        </goals>
                        <configuration>
                            <targetDirectory>../teavm-output/text-demo</targetDirectory>
                            <mainClass>TextDemo</mainClass>
                            <minifying>false</minifying>
                            <sourceMapsGenerated>true</sourceMapsGenerated>
                            <optimization>SIMPLE</optimization>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
EOF
        fi
        
        if [ ! -f "JavaDocs/src/TextDemo.java" ]; then
          echo "üìÑ Creating TextDemo.java..."
          cat > JavaDocs/src/TextDemo.java << 'EOF'
import org.teavm.jso.browser.Window;
import org.teavm.jso.dom.html.HTMLDocument;
import org.teavm.jso.dom.html.HTMLElement;
import org.teavm.jso.dom.html.TextAreaElement;

public class TextDemo {
    private static HTMLDocument document;
    private static HTMLElement container;
    private static TextAreaElement textArea;
    
    public static void main(String[] args) {
        document = HTMLDocument.current();
        container = document.getElementById("teavm-container");
        
        if (container == null) {
            Window.alert("Container element not found!");
            return;
        }
        
        createUI();
        addOutput("üöÄ TextDemo Java application loaded successfully!");
        addOutput("‚úÖ Running in browser via TeaVM");
        addOutput("üìù Type in the text area below");
    }
    
    private static void createUI() {
        container.setInnerHTML("");
        
        HTMLElement title = document.createElement("h3");
        title.setInnerHTML("üìù Java Text Editor");
        title.setAttribute("style", "color: #2c3e50; margin-bottom: 20px;");
        container.appendChild(title);
        
        textArea = (TextAreaElement) document.createElement("textarea");
        textArea.setAttribute("id", "text-editor");
        textArea.setAttribute("placeholder", "Start typing your text here...");
        textArea.setAttribute("style", 
            "width: 100%; height: 150px; padding: 12px; margin: 10px 0; " +
            "border: 2px solid #e1e5e9; border-radius: 6px; " +
            "font-family: 'Courier New', monospace; font-size: 14px; " +
            "resize: vertical; box-sizing: border-box;");
        container.appendChild(textArea);
        
        HTMLElement buttonContainer = document.createElement("div");
        buttonContainer.setAttribute("style", 
            "margin: 15px 0; display: flex; flex-wrap: wrap; gap: 8px;");
        
        String[] buttons = {
            "Clear Text", "To UPPERCASE", "to lowercase", "Word Count", 
            "Character Count", "Reverse Text"
        };
        
        for (String buttonText : buttons) {
            HTMLElement button = document.createElement("button");
            button.setInnerHTML(buttonText);
            button.setAttribute("style", 
                "padding: 8px 16px; border: none; border-radius: 4px; " +
                "background: #007bff; color: white; cursor: pointer; " +
                "font-size: 13px; transition: background 0.2s;");
            button.addEventListener("click", (event) -> handleButtonClick(buttonText));
            buttonContainer.appendChild(button);
        }
        
        container.appendChild(buttonContainer);
        
        HTMLElement output = document.createElement("div");
        output.setAttribute("id", "teavm-output");
        output.setAttribute("style", 
            "margin-top: 20px; padding: 15px; background: #f8f9fa; " +
            "border: 1px dashed #dee2e6; border-radius: 6px; " +
            "min-height: 60px; font-family: monospace; font-size: 13px;");
        container.appendChild(output);
    }
    
    private static void handleButtonClick(String action) {
        String text = textArea.getValue();
        
        switch (action) {
            case "Clear Text":
                textArea.setValue("");
                addOutput("üóëÔ∏è Text cleared");
                break;
            case "To UPPERCASE":
                textArea.setValue(text.toUpperCase());
                addOutput("üî† Converted to UPPERCASE");
                break;
            case "to lowercase":
                textArea.setValue(text.toLowerCase());
                addOutput("üî° Converted to lowercase");
                break;
            case "Word Count":
                int wordCount = text.trim().isEmpty() ? 0 : text.trim().split("\\s+").length;
                addOutput("üìä Word count: " + wordCount);
                break;
            case "Character Count":
                int charCount = text.length();
                addOutput("üî¢ Character count: " + charCount);
                break;
            case "Reverse Text":
                textArea.setValue(new StringBuilder(text).reverse().toString());
                addOutput("üîÑ Text reversed");
                break;
        }
    }
    
    private static void addOutput(String message) {
        HTMLElement output = document.getElementById("teavm-output");
        HTMLElement messageDiv = document.createElement("div");
        messageDiv.setInnerHTML("‚Ä¢ " + message);
        messageDiv.setAttribute("style", "margin: 4px 0; padding: 2px 0; color: #495057;");
        output.appendChild(messageDiv);
        output.scrollTop = output.scrollHeight;
    }
}
EOF
        fi
        
        echo "üî® Building with Maven..."
        cd JavaDocs
        mvn clean compile
        
    - name: List generated files
      run: |
        echo "üìÅ Generated TeaVM files:"
        if [ -d "teavm-output/text-demo" ]; then
          ls -la teavm-output/text-demo/
          echo "üìä File sizes:"
          du -sh teavm-output/text-demo/*.js
          echo "‚úÖ TeaVM compilation successful!"
        else
          echo "‚ùå teavm-output/text-demo directory not created"
          exit 1
        fi
        
    - name: Upload TeaVM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: teavm-output
        path: teavm-output/
        retention-days: 30
        if-no-files-found: error